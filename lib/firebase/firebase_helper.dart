import 'package:backpack/features/assignment/assignment.dart';
import 'package:backpack/features/profile/profile.dart';
import 'package:backpack/features/course/course.dart';
import 'package:cloud_firestore/cloud_firestore.dart';

class FirebaseHelper {
  FirebaseHelper() {
    firestore = FirebaseFirestore.instance;
    users = firestore.collection('users');
    courses = firestore.collection('courses');
    assignments = firestore.collection('assignments');
  }
  late FirebaseFirestore firestore;
  late CollectionReference users;
  late CollectionReference courses;
  late CollectionReference assignments;

  // User Collection Actions //
  Future<Map<String, dynamic>> readUserDetail(String id) async {
    final snapshot = await users.doc(id).get();
    return snapshot.data() as Map<String, dynamic>;
  }

  Future insertUserDetail({required UserDetail userDetail}) async {
    await users.doc(userDetail.id).set(userDetail.toDatabase());
  }

  Future updateUserDetail(UserDetail userDetail) async {
    await users.doc(userDetail.id).update(userDetail.toDatabase());
  }

  Future deleteUserDetail(String id) async {
    await users.doc(id).delete();
  }

  // Course Collection Actions //
  // Only read courses for a user's list of enrolled courseIds
  Future<List<Course>> readCourses(List<String> courseIds) async {
    final courseList = <Course>[];
    for (String id in courseIds) {
      final snapshot = await courses.doc(id).get();
      final course = Course.fromDatabase(
          snapshot.data() as Map<String, dynamic>, snapshot.id);
      courseList.add(course);
    }
    return courseList;
  }

  //TODO Assignment Actions
  Future<List<Assignment>> readAssignments() async {
    final snapshot = await assignments.get();
    final assignmentList = <Assignment>[];

    for (var item in snapshot.docs) {
      final assignment =
          Assignment.fromMap(item.data() as Map<String, dynamic>, item.id);
      assignmentList.add(assignment);
    }
    return assignmentList;
  }

  // Returns the id generated by firebase
  Future insertAssignment(Assignment assignment) async {
    final newAssignmentId = assignments.doc();
    await newAssignmentId.set(assignment.toMap());
  }

  Future deleteAssignment(String assignmentId) async {
    await assignments.doc(assignmentId).delete();
  }
}
